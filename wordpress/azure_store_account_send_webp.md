# Hooks to send the webpp files generated by the '' plugin using another 'Microsoft Azure Storage for WordPress' plugin

## copy webp image after generating thumbnails
```php
/**
 * Function to copy webp files to Azure storage after generating thumbnails
 * @param $metadata
 * @param $attachment_id
 * @return mixed
 */
function copiar_imagem_webp_apos_thumbnails($metadata, $attachment_id) {

    // Verifica se a classe Windows_Azure_Helper existe
    if (!class_exists('Windows_Azure_Helper')) {
        return $metadata;
    }

    if(!Windows_Azure_Helper::get_use_for_default_upload()){
        return $metadata;
    }

    // Função auxiliar para copiar o arquivo webp se existir
    function copy_webp_to_azure($file) {
        // Muda a extensão do arquivo para webp
        $webp_file = apply_filters('type_images_webp', $file);

        // Verifica se o arquivo webp existe
        if (file_exists($webp_file)) {

            // Caminho da pasta de upload do WordPress
            $upload_dir = wp_upload_dir();

            // Parâmetros para o envio do arquivo WebP
            $container_name = Windows_Azure_Helper::get_default_container();
            $blob_name = substr($upload_dir['subdir'], 1) . '/' . basename($webp_file); // Obtém apenas o nome do arquivo, ignorando o caminho
            $local_path = $webp_file; // Usamos o caminho completo do arquivo para o envio

            // Envia o arquivo WebP para o armazenamento do Azure
            $result = Windows_Azure_Helper::put_uploaded_file_to_blob_storage($container_name, $blob_name, $local_path);

            // Log para verificar o resultado do envio
            if (!$result) {
                error_log('Erro ao enviar o arquivo webp para o Azure: ' . $webp_file);
            }

        } else {
            error_log('O arquivo webp não existe: ' . $webp_file);
        }
    }

    // Copiar o arquivo original
    $file = get_attached_file($attachment_id);
    copy_webp_to_azure($file);

    // Copiar os thumbnails
    if (isset($metadata['sizes'])) {
        foreach ($metadata['sizes'] as $size) {
            $thumb_file = pathinfo($file, PATHINFO_DIRNAME) . '/' . $size['file'];
            copy_webp_to_azure($thumb_file, $metadata, $attachment_id );
        }
    }

    return $metadata;
}
add_filter('wp_generate_attachment_metadata', 'copiar_imagem_webp_apos_thumbnails', 1, 2);
```

## Delete webp thumbnails
```php
function delete_webp_thumbnails( $post_id ){
    if ( is_numeric( $post_id ) ) {
        $media_info = get_post_meta( $post_id, 'windows_azure_storage_info', true );

        if ( ! empty( $media_info ) ) {
            // Delete media file from blob storage.
            $container_name = $media_info['container'];
            $blob_name      = apply_filters('type_images_webp', $media_info['blob']);
            \Windows_Azure_Helper::delete_blob( $container_name, $blob_name );

            // Delete associated thumbnails from blob storage (if any).
            $thumbnails = $media_info['thumbnails'];
            if ( ! empty( $thumbnails ) ) {
                foreach ( $thumbnails as $thumbnail_blob ) {
                    $thumbnail_blob_path = apply_filters('type_images_webp', $thumbnail_blob);
                    \Windows_Azure_Helper::delete_blob( $container_name, $thumbnail_blob_path );
                }
            }
        }
    }
}
add_action( 'delete_attachment', 'delete_webp_thumbnails' );

```

## Filter change the file extension to webp
```php
/**
 * Muda a extensão do arquivo para webp
 */
add_filter('type_images_webp', function( $file ) {
    return preg_replace('/\.(jpg|jpeg|png)$/i', '.webp', $file);;
});

```
